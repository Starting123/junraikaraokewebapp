<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - Junrai Karaoke</title>
    <link rel="stylesheet" href="/css/global.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .success-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            text-align: center;
        }
        
        .success-icon {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 1rem;
            animation: bounce 1s ease-in-out;
        }
        
        .success-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
        }
        
        .receipt-highlight {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        .receipt-btn {
            background: white;
            color: #27ae60;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .receipt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .loading-receipt {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .success-title {
            color: var(--success);
            margin-bottom: 1rem;
        }
        
        .booking-info {
            background: var(--light-gray);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: left;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--gray);
        }
        
        .info-row:last-child {
            border-bottom: none;
            font-weight: bold;
            color: var(--primary-orange);
        }
        
        .receipt-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .receipt-number {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .view-receipt-link {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .view-receipt-link .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .view-receipt-link .btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            80% { transform: translateY(-10px); }
        }
        
        @media (max-width: 768px) {
            .actions {
                flex-direction: column;
            }
            
            .success-container {
                margin: 1rem;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <a href="/" class="navbar-brand">
                    <i class="fas fa-microphone-alt"></i>
                    Junrai Karaoke
                </a>
                <ul class="navbar-nav">
                    <li><a href="/" class="nav-link">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
                    <li><a href="/rooms" class="nav-link">‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞</a></li>
                    <li><a href="/bookings" class="nav-link">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="success-container">
            <div class="success-card">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <h1 class="success-title">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h1>

                <p class="text-muted">‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                
                <div class="booking-info" id="bookingInfo">
                    <h3><i class="fas fa-receipt"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                    <div id="bookingDetails">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                        </div>
                    </div>
                </div>
                
                <!-- Receipt Section -->
                <div class="loading-receipt" id="receiptLoading">
                    <div style="margin: 10px 0;">
                        <i class="fas fa-file-pdf fa-2x" style="color: #3498db; margin-bottom: 10px;"></i>
                    </div>
                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...</h4>
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à PDF
                    </div>
                    <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì
                    </p>
                </div>
                
                <div class="booking-info" id="receiptInfo" style="display: none;">
                    <div id="receiptDetails">
                        <div id="receiptLinks"></div>
                    </div>
                </div>

                <div class="actions">
                    <a href="/bookings" class="btn btn-primary">
                        <i class="fas fa-list"></i> ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                    </a>
                    <a href="/receipts" class="btn btn-primary">
                        <i class="fas fa-receipt"></i> ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </a>
                    <a href="/rooms" class="btn btn-secondary">
                        <i class="fas fa-plus"></i> ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    </a>
                    <a href="/" class="btn btn-outline">
                        <i class="fas fa-home"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Server-side data injection via data attributes -->
    <div id="serverData" 
         data-booking='<% if (typeof booking !== "undefined" && booking) { %><%- JSON.stringify(booking) %><% } else { %>null<% } %>'
         data-receipt-info='<% if (typeof receiptInfo !== "undefined" && receiptInfo) { %><%- JSON.stringify(receiptInfo) %><% } else { %>null<% } %>'
         style="display: none;"></div>
    
    <script>
        // Read server data from data attributes
        const serverDataEl = document.getElementById('serverData');
        
        try {
            const bookingData = serverDataEl.getAttribute('data-booking');
            window.serverBooking = bookingData && bookingData !== 'null' ? JSON.parse(bookingData) : null;
            console.log('üîç Server Booking Data:', window.serverBooking);
        } catch (e) {
            console.error('Error parsing booking data:', e);
            window.serverBooking = null;
        }
        
        try {
            const receiptData = serverDataEl.getAttribute('data-receipt-info');
            window.serverReceiptInfo = receiptData && receiptData !== 'null' ? JSON.parse(receiptData) : null;
            console.log('üîç Server Receipt Info:', window.serverReceiptInfo);
        } catch (e) {
            console.error('Error parsing receipt data:', e);
            window.serverReceiptInfo = null;
        }
    </script>
    
    <script>
        console.log('üîç URL Parameters:', {
            booking_id: new URLSearchParams(window.location.search).get('booking_id'),
            payment_intent: new URLSearchParams(window.location.search).get('payment_intent')
        });
    </script>
    
    <script>
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à
        window.addEventListener('beforeunload', function(e) {
            const message = '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ? ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            e.returnValue = message;
            return message;
        });

        // ‡∏î‡∏∂‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å URL
        const urlParams = new URLSearchParams(window.location.search);
        const paymentIntentId = urlParams.get('payment_intent');
        const bookingId = urlParams.get('booking_id');
        
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å server ‡∏´‡∏£‡∏∑‡∏≠ URL parameters
        if (window.serverBooking) {
            // ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏≤‡∏Å server
            displayBookingDetails(window.serverBooking);
            
            if (window.serverReceiptInfo) {
                // ‡∏°‡∏µ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß - ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                setTimeout(() => {
                    displayReceiptInfo(window.serverReceiptInfo);
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
                    addViewReceiptLink();
                }, 300); // ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0.3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            } else {
                // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á
                setTimeout(() => {
                    displayNoReceipt();
                }, 1500); // ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
            }
        } else if (!paymentIntentId && !bookingId) {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
            document.getElementById('bookingDetails').innerHTML = `
                <div class="info-row">
                    <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                    <span style="color: var(--success);">
                        <i class="fas fa-check"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    </span>
                </div>
                <div class="info-row">
                    <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞:</span>
                    <span>${new Date().toLocaleDateString('th-TH')}</span>
                </div>
            `;
        } else {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
            loadBookingDetails();
        }
        
        async function loadBookingDetails() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/auth';
                    return;
                }
                
                let url = '/api/payments/my-payments?limit=1';
                if (bookingId) {
                    url = `/api/bookings/${bookingId}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const booking = bookingId ? result.booking : result.payments[0];
                    displayBookingDetails(booking);
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('Error loading booking details:', error);
                document.getElementById('bookingDetails').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ
                    </div>
                `;
            }
        }
        
        function displayBookingDetails(booking) {
            const startTime = new Date(booking.start_time).toLocaleString('th-TH');
            const endTime = new Date(booking.end_time).toLocaleString('th-TH');
            const amount = parseFloat(booking.total_price || booking.amount);
            
            document.getElementById('bookingDetails').innerHTML = `
                <div class="info-row">
                    <span><i class="fas fa-door-open"></i> ‡∏´‡πâ‡∏≠‡∏á:</span>
                    <span>${booking.room_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-tag"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span>
                    <span>${booking.type_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-clock"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°:</span>
                    <span>${startTime}</span>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-clock"></i> ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</span>
                    <span>${endTime}</span>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-credit-card"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞:</span>
                    <span>${booking.method === 'stripe' ? '‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (Stripe)' : booking.method}</span>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-check-circle"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                    <span style="color: var(--success);">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-money-bill"></i> ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                    <span>${amount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span>
                </div>
            `;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (booking.receipt) {
                displayReceiptInfo(booking.receipt);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô
                setTimeout(() => {
                    document.getElementById('receiptLoading').innerHTML = `
                        <div style="margin: 10px 0;">
                            <i class="fas fa-exclamation-triangle fa-2x" style="color: #f39c12; margin-bottom: 10px;"></i>
                        </div>
                        <h4 style="margin: 0 0 10px 0; color: #e67e22;">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°</h4>
                        <p style="font-size: 14px; color: #7f8c8d;">
                            ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á<br>
                            ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ <a href="/receipts" style="color: #3498db;">‡∏£‡∏ß‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</a> ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
                        </p>
                        <a href="/receipts" class="btn btn-primary" style="margin-top: 10px;">
                            <i class="fas fa-receipt"></i> ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </a>
                    `;
                }, 3000); // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            }
        }

        function displayReceiptInfo(receipt) {
            // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
            document.getElementById('receiptLoading').style.display = 'none';
            document.getElementById('receiptInfo').style.display = 'block';
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô highlight box ‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô
            document.getElementById('receiptInfo').className = 'receipt-highlight';
            document.getElementById('receiptInfo').innerHTML = `
                <h3 style="margin: 0 0 15px 0;">
                    <i class="fas fa-file-pdf" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                    üéâ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!
                </h3>
                <p style="margin-bottom: 20px; font-size: 16px;">
                    ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </p>
                <div style="margin: 20px 0;">
                    <a href="${receipt.downloadUrl}" class="receipt-btn" target="_blank">
                        <i class="fas fa-eye"></i> ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à PDF
                    </a>
                    <a href="${receipt.downloadUrl}" class="receipt-btn" download>
                        <i class="fas fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    </a>
                </div>
                <p style="font-size: 14px; opacity: 0.9; margin: 10px 0 0 0;">
                    <i class="fas fa-receipt"></i> ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${receipt.receiptNumber || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                </p>
            `;
        }
        
        function displayNoReceipt() {
            // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
            document.getElementById('receiptLoading').style.display = 'none';
            document.getElementById('receiptInfo').style.display = 'block';
            document.getElementById('receiptInfo').innerHTML = `
                <div style="text-align: center; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <h4>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°</h4>
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</p>
                    <a href="/receipts" class="btn btn-primary" style="margin-top: 10px;">
                        <i class="fas fa-receipt"></i> ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </a>
                </div>
            `;
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° countdown timer
        let countdown = 60; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        const countdownElement = document.createElement('div');
        countdownElement.id = 'countdown';
        countdownElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        `;
        document.body.appendChild(countdownElement);

        const updateCountdown = () => {
            countdownElement.innerHTML = `
                <i class="fas fa-clock"></i> 
                ‡∏à‡∏∞‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô ${countdown} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                <button onclick="clearTimeout(redirectTimer); countdownElement.remove();" 
                        style="margin-left: 10px; background: #e74c3c; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer;">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            `;
            countdown--;
        };

        updateCountdown();
        const countdownInterval = setInterval(() => {
            updateCountdown();
            if (countdown < 0) {
                clearInterval(countdownInterval);
            }
        }, 1000);

        // Auto redirect after 60 seconds
        const redirectTimer = setTimeout(() => {
            if (confirm('‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                window.location.href = '/bookings';
            } else {
                countdownElement.remove();
            }
        }, 60000);
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
        function addViewReceiptLink() {
            if (!window.serverReceiptInfo || !window.serverReceiptInfo.receipt_number) return;
            
            const receiptContainer = document.querySelector('.receipt-container');
            if (receiptContainer) {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                if (!receiptContainer.querySelector('.view-receipt-link')) {
                    const linkDiv = document.createElement('div');
                    linkDiv.className = 'mt-3 text-center view-receipt-link';
                    linkDiv.innerHTML = `
                        <a href="/api/receipts/view/${window.serverReceiptInfo.receipt_number}" 
                           target="_blank" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt"></i> 
                            ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                        </a>
                        <small class="d-block mt-1 text-muted">
                            ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${window.serverReceiptInfo.receipt_number}
                        </small>
                    `;
                    receiptContainer.appendChild(linkDiv);
                }
            }
        }
    </script>
</body>
</html>