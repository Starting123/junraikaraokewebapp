<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á - Junrai Karaoke</title>
    <link rel="stylesheet" href="/stylesheets/global.css">
    <link rel="stylesheet" href="/stylesheets/bookings.css">
    <link rel="stylesheet" href="/stylesheets/cinema-timeslots.css">
    <link rel="stylesheet" href="/stylesheets/responsive-fixes.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Stripe JavaScript -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Include booking modules -->
    <script src="/javascripts/modules/booking.js"></script>
    <script src="/javascripts/modules/cinema-timeslots.js"></script>
    
    <!-- Inline CSS for file upload area debugging -->
    <style>
        #transferProofForm {
            display: none !important;
        }
        
        #transferProofForm.show {
            display: block !important;
        }
        
        .file-upload-area-debug {
            border: 4px dashed #E07B39 !important;
            background: #FFF3E0 !important;
            min-height: 160px !important;
            padding: 25px !important;
            margin: 20px 0 !important;
            border-radius: 15px !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
            cursor: pointer !important;
            position: relative !important;
            box-shadow: 0 4px 15px rgba(224, 123, 57, 0.3) !important;
            transition: all 0.3s ease !important;
        }
        
        .file-upload-area-debug:hover {
            border-color: #2ECC71 !important;
            background: #E8F5E8 !important;
            transform: translateY(-3px) !important;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4) !important;
        }
        
        /* Payment Modal Display Fix */
        .modal {
            display: none !important;
            position: fixed !important;
            z-index: 10000 !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.5) !important;
        }
        
        .modal.show {
            display: block !important;
        }
        
        .modal-content {
            background: white !important;
            margin: 5% auto !important;
            padding: 0 !important;
            border-radius: 12px !important;
            width: 90% !important;
            max-width: 600px !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            position: relative !important;
        }
        
        /* Emergency Mobile Button Fix */
        @media (max-width: 768px) {
            .booking-footer {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
                padding-top: 16px !important;
                margin-top: 16px !important;
                border-top: 1px solid #ddd !important;
                overflow: visible !important;
            }
            
            .booking-footer .btn {
                width: 100% !important;
                min-height: 48px !important;
                padding: 14px 16px !important;
                font-size: 15px !important;
                font-weight: 600 !important;
                border-radius: 10px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 8px !important;
                text-decoration: none !important;
                box-sizing: border-box !important;
                opacity: 1 !important;
                visibility: visible !important;
                position: relative !important;
                z-index: 100 !important;
                margin: 0 !important;
                cursor: pointer !important;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1) !important;
                touch-action: manipulation !important;
            }
            
            .booking-footer .btn-success {
                background: #28a745 !important;
                color: white !important;
                border: 2px solid #28a745 !important;
            }
            
            .booking-footer .btn-warning {
                background: #ffc107 !important;
                color: #212529 !important;
                border: 2px solid #ffc107 !important;
            }
            
            .booking-footer .btn-outline {
                background: white !important;
                color: #E07B39 !important;
                border: 2px solid #E07B39 !important;
            }
            
            .booking-footer .btn-info {
                background: #17a2b8 !important;
                color: white !important;
                border: 2px solid #17a2b8 !important;
            }
            
            .booking-footer .btn i {
                font-size: 16px !important;
            }
            
            .payment-status {
                width: 100% !important;
                padding: 14px !important;
                text-align: center !important;
                border-radius: 10px !important;
                font-size: 15px !important;
                font-weight: 600 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 8px !important;
            }
            
            .booking-card {
                overflow: visible !important;
                margin: 8px 0 !important;
            }
        }
        
        .file-upload-area-debug .upload-text {
            pointer-events: none !important;
            z-index: 1 !important;
        }
        
        .file-upload-area-debug .upload-text i {
            font-size: 4rem !important;
            color: #E07B39 !important;
            margin-bottom: 15px !important;
        }
        
        .file-upload-area-debug .upload-text p {
            font-size: 1.2rem !important;
            font-weight: 700 !important;
            color: #8B4513 !important;
            margin: 10px 0 !important;
        }
        
        .file-upload-area-debug .upload-text small {
            font-size: 1rem !important;
            color: #666 !important;
            line-height: 1.5 !important;
        }
        
        .file-input-debug {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            opacity: 0 !important;
            cursor: pointer !important;
            z-index: 2 !important;
        }
        
        /* Enhanced File Upload Styles */
        .enhanced-file-upload {
            margin: 20px 0 !important;
        }
        
        .upload-container {
            display: flex !important;
            align-items: stretch !important;
            gap: 0 !important;
            border: 3px solid #E07B39 !important;
            border-radius: 12px !important;
            overflow: hidden !important;
            background: white !important;
            box-shadow: 0 4px 12px rgba(224, 123, 57, 0.2) !important;
            transition: all 0.3s ease !important;
        }
        
        .upload-container:hover {
            border-color: #2ECC71 !important;
            box-shadow: 0 6px 16px rgba(46, 204, 113, 0.3) !important;
            transform: translateY(-2px) !important;
        }
        
        .upload-btn {
            background: #E07B39 !important;
            color: white !important;
            border: none !important;
            padding: 20px 25px !important;
            font-weight: 600 !important;
            font-size: 1rem !important;
            border-radius: 0 !important;
            min-width: 180px !important;
            transition: all 0.3s ease !important;
        }
        
        .upload-btn:hover {
            background: #2ECC71 !important;
            transform: scale(1.02) !important;
        }
        
        .upload-info {
            flex: 1 !important;
            padding: 15px 20px !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            background: #FFF3E0 !important;
        }
        
        .file-name-display {
            color: #666 !important;
            font-size: 1rem !important;
            margin-bottom: 5px !important;
            font-weight: 500 !important;
        }
        
        .file-name-display.has-file {
            color: #2ECC71 !important;
            font-weight: 600 !important;
        }
        
        .upload-hint {
            color: #8B4513 !important;
            font-size: 0.85rem !important;
            margin: 0 !important;
        }
        
        /* Enhanced File Preview */
        .file-preview-enhanced {
            margin-top: 15px !important;
            border: 2px solid #2ECC71 !important;
            border-radius: 10px !important;
            overflow: hidden !important;
            background: white !important;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.2) !important;
        }
        
        .preview-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 15px 20px !important;
            background: #E8F5E8 !important;
            border-bottom: 1px solid #2ECC71 !important;
        }
        
        .file-details {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            flex: 1 !important;
        }
        
        .file-info-text {
            color: #155724 !important;
            font-weight: 600 !important;
            font-size: 0.95rem !important;
        }
        
        .preview-content {
            padding: 15px !important;
            text-align: center !important;
        }
        
        .preview-image {
            max-width: 100% !important;
            max-height: 200px !important;
            border-radius: 8px !important;
            border: 1px solid #dee2e6 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        .upload-tips {
            margin-top: 10px !important;
            text-align: center !important;
        }
        
        .upload-tips small {
            color: #666 !important;
            font-size: 0.85rem !important;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .upload-container {
                flex-direction: column !important;
            }
            
            .upload-btn {
                min-width: auto !important;
                padding: 18px !important;
                border-radius: 0 !important;
            }
            
            .upload-info {
                text-align: center !important;
                padding: 20px !important;
            }
            
            .preview-header {
                flex-direction: column !important;
                gap: 10px !important;
                text-align: center !important;
            }
            
            .file-details {
                justify-content: center !important;
            }
        }
    </style>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <a href="/" class="navbar-brand">
                    <i class="fas fa-microphone-alt"></i>
                    Junrai Karaoke
                </a>
                <ul class="navbar-nav">
                    <li><a href="/" class="nav-link">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
                    <li><a href="/rooms" class="nav-link">‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞</a></li>
                    <li><a href="/bookings" class="nav-link active">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</a></li>
                    <li><a href="/contact" class="nav-link">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</a></li>
                    <li><a href="/dashboard" class="nav-link" id="dashboardLink" style="display: none;">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</a></li>
                    <li><a href="/admin" class="nav-link" id="adminLink" style="display: none;">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</a></li>
                    <li><a href="/auth" class="nav-link" id="authLink">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></li>
                    <li><button class="btn btn-outline" onclick="logout()" id="logoutBtn" style="display: none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-calendar-alt"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞</h1>
            <p>‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <!-- Booking Tabs -->
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('booking')">
                    <i class="fas fa-plus-circle"></i>
                    ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                </button>
                <button class="tab-btn" onclick="showTab('mybookings')" id="myBookingsTab" style="display: none;">
                    <i class="fas fa-list"></i>
                    ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </button>
                <button class="tab-btn" onclick="showTab('allbookings')" id="allBookingsTab" style="display: none;">
                    <i class="fas fa-users"></i>
                    ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>

            <!-- New Booking Tab -->
            <div class="tab-content active" id="bookingTab">
                <div class="booking-form-container">
                    <div class="room-selection">
                        <h3><i class="fas fa-door-open"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</h3>
                        <div class="room-grid" id="availableRooms">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Selected room info -->
                    <div class="room-info-summary" id="roomInfoSummary" style="display: none;">
                        <h3><i class="fas fa-info-circle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h3>
                        <div id="roomDetails">
                            <!-- Room details will be dynamically loaded here -->
                        </div>
                    </div>

                    <!-- Cinema-Style Time Slot Selection -->
                    <div class="timeslot-selection" id="timeslotSelection" style="display: none;">
                        <div id="cinema-timeslot-booking">
                            <!-- Cinema booking interface will be rendered here -->
                        </div>
                    </div>

                    <div class="booking-details" id="bookingForm" style="display: none;">
                        <h3><i class="fas fa-calendar-check"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                        
                        <!-- Selected Time Slot Display -->
                        <div id="selectedTimeSlot" class="selected-timeslot-info" style="display: none;">
                            <!-- Selected time slot info will be shown here -->
                        </div>
                        
                        <!-- Booking Form -->
                        <form id="newBookingForm" method="POST" action="/api/book">
                          <!-- Hidden fields for selected time slot -->
                          <input type="hidden" id="selected_start_time" name="start_time" required>
                          <input type="hidden" id="selected_end_time" name="end_time" required>
                          <input type="hidden" id="selected_duration" name="duration_hours" value="1">
                          
                          <div class="form-group">
                            <label for="fullname">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="fullname" name="fullname" class="form-control" required>
                          </div>
            
                          <div class="form-group">
                            <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="text" id="phone" name="phone" class="form-control" required>
                          </div>
            
                          <div class="form-group">
                            <label for="address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                            <input type="text" id="address" name="address" class="form-control">
                          </div>
            
                          <div class="booking-actions">
                            <button type="button" class="btn btn-secondary" onclick="backToTimeslots()">
                              <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
                            </button>
                            <button type="submit" class="btn btn-primary">
                              <i class="fas fa-calendar-check"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                            </button>
                          </div>
                        </form>
                      </div>
                      
                      <!-- Selected room info (hidden fields) -->
                      <div id="selectedRoomInfo" class="selected-room" style="display: none;"></div>
                      <input type="hidden" id="selectedRoomId" name="selectedRoomId">
                </div>
            </div>

            <!-- My Bookings Tab -->
            <div class="tab-content" id="mybookingsTab">
                <div class="bookings-list" id="myBookingsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>
                    </div>
                </div>
            </div>

            <!-- All Bookings Tab (Admin) -->
            <div class="tab-content" id="allbookingsTab">
                <div class="admin-controls">
                    <div class="filter-controls">
                        <select id="statusFilter" onchange="filterAllBookings()" class="form-select">
                            <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="active">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                            <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                            <option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                        </select>
                        
                        <select id="roomFilter" onchange="filterAllBookings()" class="form-select">
                            <option value="">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>
                </div>
                
                <div class="bookings-list" id="allBookingsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Detail Modal -->
    <div class="modal-overlay" id="bookingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Global variables
        let currentUser = null;
        let availableRooms = [];
        let allRooms = [];
        let myBookings = [];
        let allBookings = [];
        let currentBookingId = null; // For payment modal
        const API_BASE = '/api';
        
        // Stripe variables (moved to top to prevent hoisting issues)
        let stripe = null;
        let elements = null;
        let cardElement = null;
        let stripeConfig = null;
        let currentPaymentIntent = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            initializeNavbar();
            requireAuth(); // Redirect to login if not authenticated
            checkBookingAccess(); // Check booking-specific access
            loadAvailableRooms();
            setDefaultDateTime();
            initializeStripe();
            setupPaymentMethodListeners();
            loadRoomInfo();
        });

        // Booking-specific access check
        function checkBookingAccess() {
            const user = getCurrentUser();
            if (user) {
                currentUser = user;
                document.getElementById('myBookingsTab').style.display = 'block';
                
                // Show admin-only booking features
                if (isAdmin()) {
                    document.getElementById('allBookingsTab').style.display = 'block';
                }
            }
        }



        // Enhanced fetch with auth error handling
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers
                }
            });

            if (response.status === 401 || response.status === 403) {
                showError('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                setTimeout(() => {
                    logout();
                }, 2000);
                throw new Error('Authentication failed');
            }

            return response;
        }

        // Set default date and time
        function setDefaultDateTime() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentHour = now.getHours();
            const nextHour = (currentHour + 1).toString().padStart(2, '0') + ':00';
            const endHour = (currentHour + 3).toString().padStart(2, '0') + ':00';
            
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            document.getElementById('startTime').value = nextHour;
            document.getElementById('endTime').value = endHour;
        }

        // Tab management
        function showTab(tabName, evt) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            // Use the passed event if available; otherwise try to find the button
            try {
                if (evt && evt.target) {
                    evt.target.classList.add('active');
                } else {
                    const selector = `.tab-btn[onclick="showTab('${tabName}')"]`;
                    const btn = document.querySelector(selector) || document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
                    if (btn) btn.classList.add('active');
                }
            } catch (e) {
                // ignore failures setting active class
                console.warn('showTab: could not set active button', e);
            }
            
            // Load data based on tab
            switch(tabName) {
                case 'mybookings':
                    loadMyBookings();
                    break;
                case 'allbookings':
                    loadAllBookings();
                    loadRoomsForFilter();
                    break;
            }
        }

        // Load available rooms
        async function loadAvailableRooms() {
            try {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô
                await updateRoomStatus();
                
                const response = await fetch(`${API_BASE}/rooms/roomForm`);
                if (response.ok) {
                    allRooms = await response.json();
                    availableRooms = allRooms.filter(room => room.status === 'available');
                    displayAvailableRooms();
                } else {
                    throw new Error('Failed to load rooms');
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
                document.getElementById('availableRooms').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ</p>
                    </div>
                `;
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö real-time
        async function updateRoomStatus() {
            try {
                await fetch(`${API_BASE}/rooms/update-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
            } catch (error) {
                console.error('Error updating room status:', error);
            }
        }

        // Display available rooms
        function displayAvailableRooms() {
            const container = document.getElementById('availableRooms');
            
            if (availableRooms.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-door-closed"></i>
                        <h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</h3>
                        <p>‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = availableRooms.map(room => `
                <div class="room-card" onclick="selectRoom(${room.room_id})">
                    <div class="room-status available">
                        <i class="fas fa-check-circle"></i>
                        ‡∏ß‡πà‡∏≤‡∏á
                    </div>
                    
                    <div class="room-info">
                        <h4><i class="fas fa-door-open"></i> ${room.name}</h4>
                        <p><i class="fas fa-tags"></i> ${room.type_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'}</p>
                        <p><i class="fas fa-users"></i> ${room.capacity || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏Ñ‡∏ô</p>
                    </div>
                    
                    <button class="btn btn-primary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
                </div>
            `).join('');
        }

        // Global variables for cinema booking
        let cinemaManager = null;
        let selectedRoom = null;
        let selectedTimeSlot = null;

        // Select room for booking
        function selectRoom(roomId) {
            const room = availableRooms.find(r => r.room_id === roomId);
            if (!room) return;
            
            selectedRoom = room;
            document.getElementById('selectedRoomId').value = roomId;
            
            // Display room information
            displayRoomInfo(room);
            
            // Show cinema timeslot selection
            initializeCinemaBooking(room);
            document.getElementById('timeslotSelection').style.display = 'block';
            document.getElementById('timeslotSelection').scrollIntoView({ behavior: 'smooth' });
        }

        // Display selected room information
        function displayRoomInfo(room) {
            const roomInfoSummary = document.getElementById('roomInfoSummary');
            const roomDetails = document.getElementById('roomDetails');

            if (room) {
                roomDetails.innerHTML = `
                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á:</strong> ${room.name}</p>
                    <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${room.type_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'}</p>
                    <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</strong> ${room.capacity || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏Ñ‡∏ô</p>
                `;
                roomInfoSummary.style.display = 'block';
            } else {
                roomDetails.innerHTML = '';
                roomInfoSummary.style.display = 'none';
            }
        }

        // Enhanced fix for accessing 'value' of null elements
        function updateBookingSummary() {
          const startDateElement = document.getElementById('startDate');
          const startTimeElement = document.getElementById('startTime');
          const endDateElement = document.getElementById('endDate');
          const endTimeElement = document.getElementById('endTime');

          // Ensure elements exist before accessing their values
          if (!startDateElement || !startTimeElement || !endDateElement || !endTimeElement) {
            console.error('One or more required elements are missing');
            return;
          }

          const startDate = startDateElement.value || '';
          const startTime = startTimeElement.value || '';
          const endDate = endDateElement.value || '';
          const endTime = endTimeElement.value || '';

          if (startDate && startTime && endDate && endTime) {
            try {
              const start = new Date(`${startDate}T${startTime}`);
              const end = new Date(`${endDate}T${endTime}`);
              const duration = (end - start) / (1000 * 60 * 60); // hours
              
              document.getElementById('bookingSummary').innerHTML = `
                <div class="summary-card">
                  <h4><i class="fas fa-clock"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h4>
                  <div class="summary-details">
                    <p><strong>‡πÄ‡∏£‡∏¥‡πà‡∏°:</strong> ${formatDateTime(start)}</p>
                    <p><strong>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</strong> ${formatDateTime(end)}</p>
                    <p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${duration.toFixed(2)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
                  </div>
                </div>
              `;
            } catch (error) {
              console.error('Error calculating booking summary:', error);
            }
          } else {
            console.warn('Incomplete date/time values for booking summary');
          }
        }

        // Format date time
        function formatDateTime(date) {
            return date.toLocaleString('th-TH', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Updated booking form validation for cinema timeslot system
        function validateBookingForm() {
            // Check for selected timeslot (new cinema system)
            const selectedStartTime = document.getElementById('selected_start_time');
            const selectedEndTime = document.getElementById('selected_end_time');
            const selectedRoom = document.getElementById('selectedRoomId');

            if (!selectedStartTime || !selectedEndTime || !selectedRoom) {
                console.error('Required booking elements are missing');
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                return false;
            }

            const startTimeValue = selectedStartTime.value;
            const endTimeValue = selectedEndTime.value;
            const roomIdValue = selectedRoom.value;

            if (!startTimeValue || !endTimeValue || !roomIdValue) {
                console.error('Missing booking data:', { startTimeValue, endTimeValue, roomIdValue });
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á', 'error');
                return false;
            }

            // Validate datetime format
            const start = new Date(startTimeValue);
            const end = new Date(endTimeValue);
            const now = new Date();

            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                console.error('Invalid datetime values:', { startTimeValue, endTimeValue });
                showToast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return false;
            }

            if (start <= now) {
                showToast('‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï', 'error');
                return false;
            }

            if (end <= start) {
                showToast('‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°', 'error');
                return false;
            }

            // Check personal information
            const fullname = document.getElementById('fullname');
            const phone = document.getElementById('phone');

            if (!fullname || !fullname.value.trim()) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', 'error');
                return false;
            }

            if (!phone || !phone.value.trim()) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', 'error');
                return false;
            }

            return true;
        }

        // Updated form submission handler for cinema timeslot system
        let isSubmitting = false; // Prevent double submission
        
        document.addEventListener('DOMContentLoaded', () => {
            const bookingForm = document.getElementById('newBookingForm');
            if (bookingForm) {
                bookingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Prevent double submission
                    if (isSubmitting) {
                        console.log('üö´ Already submitting, ignoring duplicate request');
                        return;
                    }
                    
                    // Validate form first
                    if (!validateBookingForm()) {
                        return;
                    }
                    
                    isSubmitting = true;
                    
                    // Get form elements (updated for cinema system)
                    const fullnameEl = document.getElementById('fullname');
                    const phoneEl = document.getElementById('phone');
                    const addressEl = document.getElementById('address');
                    const roomIdEl = document.getElementById('selectedRoomId');
                    const startTimeEl = document.getElementById('selected_start_time'); // Updated
                    const endTimeEl = document.getElementById('selected_end_time'); // Updated
                    const durationEl = document.getElementById('selected_duration'); // Updated
                    
                    const fullname = fullnameEl.value.trim();
                    const phone = phoneEl.value.trim();
                    const address = addressEl ? addressEl.value.trim() : '';
                    const roomId = roomIdEl.value;
                    const startDateTime = startTimeEl.value;
                    const endDateTime = endTimeEl.value;
                    const duration = durationEl ? parseInt(durationEl.value) : 1;
                    
                    console.log('Booking data:', {
                        fullname, phone, address, roomId, 
                        startDateTime, endDateTime, duration
                    });
                    
                    try {
                        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...', 'info');
                        
                        // Disable submit button
                        const submitBtn = bookingForm.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á...';
                        }
                        
                        const bookingData = {
                            room_id: parseInt(roomId),
                            start_time: startDateTime,
                            end_time: endDateTime,
                            duration_hours: duration,
                            fullname: fullname,
                            phone: phone,
                            address: address
                        };
                        
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/bookings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(bookingData)
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showToast('‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                            
                            // Reset form and UI
                            bookingForm.reset();
                            document.getElementById('bookingForm').style.display = 'none';
                            document.getElementById('timeslotSelection').style.display = 'none';
                            document.getElementById('selectedTimeSlot').style.display = 'none';
                            
                            // Clear selections
                            selectedRoom = null;
                            selectedTimeSlot = null;
                            
                            // Refresh bookings and rooms
                            loadMyBookings();
                            loadAvailableRooms();
                            
                            // Show success message with booking details
                            setTimeout(() => {
                                alert(`‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏´‡πâ‡∏≠‡∏á: ${selectedRoom?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}\n‡πÄ‡∏ß‡∏•‡∏≤: ${new Date(startDateTime).toLocaleString('th-TH')}\n‡∏£‡∏≤‡∏Ñ‡∏≤: ${selectedRoom?.price_per_hour || 0}‡∏ø`);
                            }, 1000);
                            
                        } else {
                            throw new Error(result.message || '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                        }
                        
                    } catch (error) {
                        console.error('Booking error:', error);
                        showToast(`‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
                    } finally {
                        // Reset submission flag and button
                        isSubmitting = false;
                        const submitBtn = bookingForm.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-check"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
                        }
                    }
                });
            }
        });

        // Reset booking form
        function resetBookingForm() {
            document.getElementById('newBookingForm').reset();
            document.getElementById('bookingForm').style.display = 'none';
            document.getElementById('selectedRoomInfo').innerHTML = '';
            document.getElementById('bookingSummary').innerHTML = '';
            setDefaultDateTime();
        }

        // Load my bookings
        async function loadMyBookings() {
            console.log('üîÑ Loading my bookings...');
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                const response = await fetch(`${API_BASE}/bookings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('üì° Bookings API Response Status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìã Bookings Data:', data);
                    
                    myBookings = data.data?.bookings || data.bookings || [];
                    console.log('üìä Processed Bookings Array:', myBookings);
                    
                    displayBookings(myBookings, 'myBookingsList');
                } else {
                    const errorData = await response.text();
                    console.error('‚ùå API Error Response:', errorData);
                    throw new Error(`HTTP ${response.status}: ${errorData}`);
                }
            } catch (error) {
                console.error('‚ùå Error loading my bookings:', error);
                document.getElementById('myBookingsList').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ: ${error.message}</p>
                        <button onclick="loadMyBookings()" class="retry-btn">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                `;
            }
        }

        // Load all bookings (admin)
        async function loadAllBookings() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/bookings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allBookings = data.bookings;
                    displayBookings(allBookings, 'allBookingsList');
                } else {
                    throw new Error('Failed to load all bookings');
                }
            } catch (error) {
                console.error('Error loading all bookings:', error);
                document.getElementById('allBookingsList').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ</p>
                    </div>
                `;
            }
        }

        // Display bookings
        function displayBookings(bookings, containerId) {
            const container = document.getElementById(containerId);
            
            if (bookings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                    </div>
                `;
                return;
            }

            // Debug: Log booking data
            console.log('üîç Displaying bookings:', bookings.map(b => ({
                id: b.booking_id,
                status: b.status,
                payment_status: b.payment_status,
                user_id: b.user_id,
                showPaymentBtn: (b.status === 'active' || b.status === 'completed') && b.payment_status === 'pending'
            })));
            
            container.innerHTML = bookings.map(booking => `
                <div class="booking-card ${booking.status}" onclick="viewBooking(${booking.booking_id})">
                    <div class="booking-header">
                        <div class="booking-status ${booking.status}">
                            <i class="fas ${getStatusIcon(booking.status)}"></i>
                            ${getStatusText(booking.status)}
                        </div>
                        <div class="booking-id">#${booking.booking_id}</div>
                    </div>
                    
                    <div class="booking-body">
                        <h4><i class="fas fa-door-open"></i> ${booking.room_name}</h4>
                        <div class="room-details">
                            <span class="room-type">${booking.type_name || '‡∏´‡πâ‡∏≠‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤'}</span>
                            <span class="room-capacity"><i class="fas fa-users"></i> ${booking.capacity || 4} ‡∏Ñ‡∏ô</span>
                        </div>
                        <div class="booking-info">
                            <div class="info-item">
                                <i class="fas fa-user"></i>
                                <span>${booking.user_name}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar"></i>
                                <span>${formatDateTime(new Date(booking.start_time))}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>${formatDateTime(new Date(booking.end_time))}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-hourglass-half"></i>
                                <span>${booking.duration_hours || 1} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                            </div>
                            <div class="info-item price">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>${booking.total_price || 0} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="booking-footer">
                        ${(booking.status === 'active' || booking.status === 'completed') && booking.payment_status === 'pending' && (currentUser.user_id === booking.user_id || currentUser.role_id === 1) ? `
                        <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); cancelBooking(${booking.booking_id})">
                            <i class="fas fa-times"></i>
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        ` : ''}
                        
                        <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); viewBookingDetails(${booking.booking_id})">
                            <i class="fas fa-eye"></i>
                            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                        
                        ${(booking.status === 'active' || booking.status === 'completed') && booking.payment_status === 'pending' && (currentUser.user_id === booking.user_id || currentUser.role_id === 1) ? `
                        <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); showPaymentModal(${booking.booking_id})">
                            <i class="fas fa-credit-card"></i>
                            ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                        </button>
                        ` : ''}
                        
                        ${booking.payment_status === 'paid' ? `
                        <span class="payment-status paid">
                            <i class="fas fa-check-circle"></i>
                            ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß
                        </span>
                        <button class="btn btn-info btn-sm" onclick="event.stopPropagation(); downloadPaymentSlip(${booking.booking_id})" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
                            <i class="fas fa-download"></i>
                            ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à PDF
                        </button>
                        ` : booking.payment_status === 'pending' ? `
                        <span class="payment-status pending">
                            <i class="fas fa-clock"></i>
                            ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                        </span>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Get status icon
        function getStatusIcon(status) {
            switch(status) {
                case 'active': return 'fa-clock';
                case 'completed': return 'fa-check-circle';
                case 'cancelled': return 'fa-times-circle';
                default: return 'fa-question-circle';
            }
        }

        // Get status text
        function getStatusText(status) {
            switch(status) {
                case 'active': return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                case 'completed': return '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
                case 'cancelled': return '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                default: return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
            }
        }

        // View booking details
        async function viewBookingDetails(bookingId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/bookings/${bookingId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showBookingDetailsModal(data.booking);
                } else {
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
                }
            } catch (error) {
                console.error('View booking error:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', 'error');
            }
        }

        // Show booking details modal
        function showBookingDetailsModal(booking) {
            const modal = document.getElementById('bookingDetailsModal');
            const modalBody = document.getElementById('bookingDetailsBody');
            
            modalBody.innerHTML = `
                <div class="booking-details">
                    <div class="detail-row">
                        <strong><i class="fas fa-door-open"></i> ‡∏´‡πâ‡∏≠‡∏á:</strong>
                        <span>${booking.room_name}</span>
                    </div>
                    <div class="detail-row">
                        <strong><i class="fas fa-tag"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á:</strong>
                        <span>${booking.type_name || '‡∏´‡πâ‡∏≠‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î'}</span>
                    </div>
                    <div class="detail-row">
                        <strong><i class="fas fa-users"></i> ‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡πâ‡∏≠‡∏á:</strong>
                        <span>${booking.capacity || 4} ‡∏Ñ‡∏ô</span>
                    </div>
                    <div class="detail-row">
                        <strong><i class="fas fa-money-bill-wave"></i> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á:</strong>
                        <span>${booking.price_per_hour || 0} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="detail-row">
                        <strong><i class="fas fa-calendar"></i> ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°:</strong>
                        <span>${formatDateTime(new Date(booking.start_time))}</span>
                    </div>
                    <div class="detail-row">
                        <strong><i class="fas fa-calendar-check"></i> ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</strong>
                        <span>${formatDateTime(new Date(booking.end_time))}</span>
                    </div>
                    <div class="detail-row">
                        <strong><i class="fas fa-hourglass-half"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong>
                        <span>${booking.duration_hours || 1} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                    </div>
                    <div class="detail-row total-price">
                        <strong><i class="fas fa-receipt"></i> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</strong>
                        <span>${booking.total_price || 0} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="detail-row">
                        <strong><i class="fas fa-info-circle"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á:</strong>
                        <span class="status-badge ${booking.room_status}">
                            ${booking.room_status === 'available' ? '‡∏ß‡πà‡∏≤‡∏á' : '‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'}
                        </span>
                    </div>
                    <div class="detail-row">
                        <strong><i class="fas fa-credit-card"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</strong>
                        <span class="payment-badge ${booking.payment_status}">
                            ${getPaymentStatusText(booking.payment_status)}
                        </span>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Get payment status text
        function getPaymentStatusText(status) {
            switch(status) {
                case 'paid': return '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß';
                case 'pending': return '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
                case 'failed': return '‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                default: return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
            }
        }

        // Show payment modal
        function showPaymentModal(bookingId) {
            console.log('üè¶ Opening payment modal for booking:', bookingId);
            currentBookingId = bookingId;
            
            // Show the payment modal
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.style.display = 'block';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                console.log('‚úÖ Payment modal opened successfully');
            } else {
                console.error('‚ùå Payment modal element not found!');
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                return;
            }
            
            // Load booking amount
            loadBookingAmount(bookingId);
            
            // Reinitialize Stripe card element when modal opens
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ modal ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ initialize Stripe
            setTimeout(async () => {
                try {
                    console.log('üéØ Payment modal opened, initializing Stripe card...');
                    
                    // Force reinitialize Stripe ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à
                    await initializeStripe();
                    
                    // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ mount card element
                    setTimeout(async () => {
                        await initializeStripeCardElement();
                    }, 200);
                    
                } catch (error) {
                    console.error('‚ùå Failed to initialize Stripe card element:', error);
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Stripe', 'error');
                }
            }, 500);
        }

        // Close payment modal
        function closePaymentModal() {
            console.log('üí∞ Closing payment modal');
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
            currentBookingId = null;
        }

        // Add modal click outside to close
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePaymentModal();
                    }
                });
            }
        });

        // Load booking amount for payment
        async function loadBookingAmount(bookingId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/bookings/${bookingId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const amountElement = document.getElementById('paymentAmount');
                    if (amountElement) {
                        amountElement.textContent = `${data.booking.total_price || 0} ‡∏ö‡∏≤‡∏ó`;
                    }
                    console.log('üí∞ Loaded amount:', data.booking.total_price);
                } else {
                    console.error('‚ùå Failed to load booking amount');
                }
            } catch (error) {
                console.error('Load booking amount error:', error);
            }
        }

        // Process payment
        async function processPayment() {
            if (!currentBookingId) return;
            
            const method = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            // For cash payment, use simple JSON request
            if (method === 'cash') {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`${API_BASE}/bookings/${currentBookingId}/payment`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            method,
                            transaction_id: null
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        showToast(data.message || '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        closeModal('paymentModal');
                        loadMyBookings();
                        loadAllBookings();
                    } else {
                        const error = await response.json();
                        showToast(error.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                    }
                } catch (error) {
                    console.error('Payment error:', error);
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', 'error');
                }
                return;
            }
            
            // For bank_transfer and qr_code, process with file upload
            processTraditionalPayment();
        }

        // Close modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                
                // Reset form data when closing specific modals
                if (modalId === 'paymentModal') {
                    const cashRadio = document.querySelector('input[name="paymentMethod"][value="cash"]');
                    if (cashRadio) cashRadio.checked = true;
                    
                    // Reset file upload
                    clearFilePreview();
                } else if (modalId === 'bookingModal') {
                    // Reset booking form if needed
                    document.getElementById('modalBody').innerHTML = '';
                }
            }
        }

        // View booking (legacy function - kept for compatibility)
        function viewBooking(bookingId) {
            viewBookingDetails(bookingId);
        }

        // Cancel booking
        async function cancelBooking(bookingId) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/bookings/${bookingId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast(data.message || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    loadMyBookings();
                    loadAllBookings();
                    loadAvailableRooms();
                } else {
                    showToast(data.message || data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', 'error');
                }
            } catch (error) {
                console.error('Cancel booking error:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', 'error');
            }
        }

        // Show toast message
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = ['bookingModal', 'bookingDetailsModal', 'paymentModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && event.target === modal) {
                    closeModal(modalId);
                }
            });
        }

        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modals = ['bookingModal', 'bookingDetailsModal', 'paymentModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && modal.style.display === 'block') {
                        closeModal(modalId);
                    }
                });
            }
        });

        // Event listeners for form updates
        ['startDate', 'startTime', 'endDate', 'endTime'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateBookingSummary);
        });
        
        // Initialize current booking ID for payment (moved to global variables section)
        // Stripe variables (moved to global variables section)

        // Initialize Stripe
        async function initializeStripe() {
            try {
                console.log('üîÑ Initializing Stripe...');
                // ‡∏î‡∏∂‡∏á Stripe config
                const response = await fetch('/api/payments/config');
                stripeConfig = await response.json();
                
                if (stripeConfig.success && stripeConfig.publishableKey) {
                    stripe = Stripe(stripeConfig.publishableKey);
                    elements = stripe.elements();
                    console.log('‚úÖ Stripe initialized successfully');
                } else {
                    throw new Error(`Stripe configuration error: ${stripeConfig.message || 'Missing publishable key'}`);
                }
            } catch (error) {
                console.error('‚ùå Error initializing Stripe:', error);
                showToast(`Stripe Error: ${error.message}`, 'error');
                throw error; // Re-throw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            }
        }

        // Initialize Stripe Card Element (called when modal opens)  
        async function initializeStripeCardElement() {
            try {
                console.log('üé¥ Initializing Stripe card element...');
                
                const cardElementContainer = document.getElementById('card-element');
                if (!cardElementContainer) {
                    throw new Error('Card element container (#card-element) not found');
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Stripe ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!stripe || !elements) {
                    throw new Error(`Stripe not ready. stripe: ${!!stripe}, elements: ${!!elements}`);
                }
                
                // Clear existing card element
                cardElementContainer.innerHTML = '';
                
                // Unmount existing card element if exists
                if (cardElement) {
                    try {
                        cardElement.unmount();
                    } catch (e) {
                        console.log('Previous card element already unmounted');
                    }
                }
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á card element ‡πÉ‡∏´‡∏°‡πà
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                        invalid: {
                            color: '#9e2146',
                        },
                    },
                });
                
                // Mount card element
                cardElement.mount('#card-element');
                console.log('‚úÖ Stripe card element mounted successfully');
                
                // Listen for realtime validation errors
                cardElement.on('change', ({error}) => {
                    const displayError = document.getElementById('card-errors');
                    if (displayError) {
                        if (error) {
                            displayError.textContent = error.message;
                        } else {
                            displayError.textContent = '';
                        }
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Error initializing Stripe card element:', error);
                showToast(`Stripe Card Error: ${error.message}`, 'error');
                
                // Show error in card element area
                const cardElementContainer = document.getElementById('card-element');
                if (cardElementContainer) {
                    cardElementContainer.innerHTML = `
                        <div style="padding: 12px; border: 1px solid #dc3545; border-radius: 8px; background: #f8d7da; color: #721c24; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 20px; margin-bottom: 8px; display: block;"></i>
                            <strong>Stripe Error</strong><br>
                            <small>${error.message}</small>
                        </div>
                    `;
                }
                throw error; // Re-throw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            }
        }

        // Setup payment method listeners
        function setupPaymentMethodListeners() {
            const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
            paymentMethods.forEach(method => {
                method.addEventListener('change', togglePaymentForms);
            });
        }

        // Toggle payment forms based on selected method
        function togglePaymentForms() {
            const selectedEl = document.querySelector('input[name="paymentMethod"]:checked');
            const selectedMethod = selectedEl ? selectedEl.value : null;
            const stripeForm = document.getElementById('stripePaymentForm');
            const traditionalForm = document.getElementById('traditionalPaymentForm');

            if (selectedMethod === 'stripe') {
                if (stripeForm) stripeForm.style.display = 'block';
                if (traditionalForm) traditionalForm.style.display = 'none';
            } else {
                if (stripeForm) stripeForm.style.display = 'none';
                if (traditionalForm) traditionalForm.style.display = 'block';
            }
        }

        // Enhanced processPayment function
        async function processPayment() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            if (selectedMethod === 'stripe') {
                await processStripePayment();
            } else {
                await processTraditionalPayment();
            }
        }

        // Process Stripe payment
        async function processStripePayment() {
            try {
                if (!stripe || !cardElement) {
                    showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                    return;
                }

                const paymentButton = document.querySelector('button[onclick="processPayment()"]');
                paymentButton.disabled = true;
                paymentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Payment Intent
                const response = await fetchWithAuth('/api/payments/create-payment-intent', {
                    method: 'POST',
                    body: JSON.stringify({
                        bookingId: currentBookingId
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                const {error} = await stripe.confirmCardPayment(result.clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: currentUser.name,
                            email: currentUser.email
                        }
                    }
                });

                if (error) {
                    console.error('Payment failed:', error);
                    showToast(`‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`, 'error');
                } else {
                    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
                    const confirmResponse = await fetchWithAuth('/api/payments/confirm', {
                        method: 'POST',
                        body: JSON.stringify({
                            paymentIntentId: result.paymentIntentId,
                            bookingId: currentBookingId
                        })
                    });

                    const confirmResult = await confirmResponse.json();

                    if (confirmResult.success) {
                        showToast('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                        closeModal('paymentModal');
                        loadMyBookings(); // Reload bookings
                    } else {
                        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', 'error');
                    }
                }

            } catch (error) {
                console.error('Error processing Stripe payment:', error);
                showToast(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', 'error');
            } finally {
                const paymentButton = document.querySelector('button[onclick="processPayment()"]');
                paymentButton.disabled = false;
                paymentButton.innerHTML = '<i class="fas fa-check"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
            }
        }

        // Process traditional payment with file upload
        async function processTraditionalPayment() {
            try {
                const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                const fileInput = document.getElementById('paymentProofFile');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!fileInput.files[0]) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', 'error');
                    return;
                }

                // ‡πÅ‡∏™‡∏î‡∏á loading state
                const paymentButton = document.querySelector('.btn-success');
                const originalText = paymentButton.innerHTML;
                paymentButton.disabled = true;
                paymentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á FormData ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå
                const formData = new FormData();
                formData.append('method', selectedMethod);
                formData.append('transaction_id', null); // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß
                formData.append('paymentProof', fileInput.files[0]);

                const response = await fetch(`${API_BASE}/bookings/${currentBookingId}/payment`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(result.message || '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', 'success');
                    closeModal('paymentModal');
                    loadMyBookings();
                    loadAllBookings();
                } else {
                    showToast(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î', 'error');
                }

                // Reset button state
                paymentButton.disabled = false;
                paymentButton.innerHTML = originalText;

            } catch (error) {
                console.error('Error processing payment:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', 'error');
                
                // Reset button state
                const paymentButton = document.querySelector('.btn-success');
                paymentButton.disabled = false;
                paymentButton.innerHTML = '<i class="fas fa-check"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
            }
        }

        // Load room information
        async function loadRoomInfo() {
            const container = document.getElementById('roomInfoContainer');
            try {
                const response = await fetch('/api/rooms');
                const rooms = await response.json();

                if (rooms.length === 0) {
                    container.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>';
                    return;
                }

                container.innerHTML = rooms.map(room => `
                    <div class="room-card">
                        <h4>${room.name}</h4>
                        <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${room.type_name}</p>
                        <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</strong> ${room.capacity} ‡∏Ñ‡∏ô</p>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${room.status === 'available' ? '‡∏ß‡πà‡∏≤‡∏á' : '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á'}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading room info:', error);
                container.innerHTML = '<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á</p>';
            }
        }

        // Handle payment method change
        document.addEventListener('change', function(e) {
            if (e.target.name === 'paymentMethod') {
                const method = e.target.value;
                const stripeForm = document.getElementById('stripePaymentForm');
                const traditionalForm = document.getElementById('traditionalPaymentForm');
                const transferProofForm = document.getElementById('transferProofForm');
                
                if (method === 'stripe') {
                    stripeForm.style.display = 'block';
                    traditionalForm.style.display = 'none';
                    transferProofForm.style.display = 'none';
                } else {
                    stripeForm.style.display = 'none';
                    
                    // Show upload form for bank_transfer and qr_code (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á traditionalForm ‡πÅ‡∏•‡πâ‡∏ß)
                    if (method === 'bank_transfer' || method === 'qr_code') {
                        transferProofForm.style.display = 'block';
                        transferProofForm.classList.add('show');
                        document.getElementById('paymentProofFile').required = true;
                        
                        // Update button text based on method
                        const uploadBtn = document.querySelector('.upload-btn');
                        if (method === 'bank_transfer') {
                            uploadBtn.innerHTML = '<i class="fas fa-university"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
                        } else if (method === 'qr_code') {
                            uploadBtn.innerHTML = '<i class="fas fa-qrcode"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ QR Payment';
                        }
                        
                        console.log('Showing file upload for method:', method);
                    } else {
                        // For cash payment, hide upload form
                        transferProofForm.style.display = 'none';
                        transferProofForm.classList.remove('show');
                        document.getElementById('paymentProofFile').required = false;
                        
                        console.log('Hiding file upload for method:', method);
                    }
                }
            }
        });

        // Handle file upload preview
        document.getElementById('paymentProofFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileNameDisplay = document.getElementById('fileName');
            const filePreview = document.getElementById('filePreview');
            const previewImage = document.getElementById('previewImage');
            const fileInfo = document.getElementById('fileInfo');
            
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showToast('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB', 'error');
                    e.target.value = '';
                    fileNameDisplay.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
                    fileNameDisplay.classList.remove('has-file');
                    filePreview.style.display = 'none';
                    return;
                }

                // Update file name display
                fileNameDisplay.textContent = file.name;
                fileNameDisplay.classList.add('has-file');
                
                // Update file info
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                fileInfo.textContent = `${file.name} (${fileSize} MB)`;
                
                // Show preview
                filePreview.style.display = 'block';
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        previewImage.src = event.target.result;
                        previewImage.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImage.style.display = 'none';
                }
            } else {
                fileNameDisplay.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
                fileNameDisplay.classList.remove('has-file');
                filePreview.style.display = 'none';
            }
        });

        // Clear file preview
        function clearFilePreview() {
            const fileInput = document.getElementById('paymentProofFile');
            const fileNameDisplay = document.getElementById('fileName');
            const filePreview = document.getElementById('filePreview');
            
            fileInput.value = '';
            fileNameDisplay.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
            fileNameDisplay.classList.remove('has-file');
            filePreview.style.display = 'none';
        }

        // Download Payment Slip PDF
        async function downloadPaymentSlip(bookingId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                    return;
                }

                // Show loading toast
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF...', 'info');

                const response = await fetch(`${API_BASE}/bookings/${bookingId}/payment-slip`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    // Get the PDF as blob
                    const blob = await response.blob();
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `payment-slip-${bookingId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    
                } else {
                    // Try to parse JSON error body for a helpful message
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        try {
                            const err = await response.json();
                            const msg = err.message || err.error || JSON.stringify(err);
                            showToast(msg || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ', 'error');
                            return;
                        } catch (parseErr) {
                            console.warn('Failed to parse JSON error response', parseErr);
                        }
                    }

                    // Fallback messages based on status
                    if (response.status === 400) {
                        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ (‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)', 'error');
                    } else if (response.status === 404) {
                        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á', 'error');
                    } else if (response.status === 403) {
                        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ', 'error');
                    } else {
                        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå)', 'error');
                    }
                    return;
                }
                
            } catch (error) {
                console.error('Error downloading payment slip:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', 'error');
            }
        }
    </script>

    <!-- Booking Details Modal -->
    <div id="bookingDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                <span class="close" onclick="closeModal('bookingDetailsModal')">&times;</span>
            </div>
            <div class="modal-body" id="bookingDetailsBody">
                <!-- Booking details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-credit-card"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <button class="modal-close" onclick="closePaymentModal()" aria-label="‡∏õ‡∏¥‡∏î">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="payment-form">
                    <div class="form-group">
                        <label><i class="fas fa-money-bill"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <div class="amount-display" id="paymentAmount">0 ‡∏ö‡∏≤‡∏ó</div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-credit-card"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <div class="payment-methods">
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="stripe" checked>
                                <i class="fas fa-credit-card"></i> ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï/PromptPay (Stripe)
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="cash">
                                <i class="fas fa-money-bill-wave"></i> ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="bank_transfer">
                                <i class="fas fa-university"></i> ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                            </label>
                            <label class="payment-method">
                                <input type="radio" name="paymentMethod" value="qr_code">
                                <i class="fas fa-qrcode"></i> QR Code
                            </label>
                        </div>
                    </div>
                    <!-- Stripe Payment Form -->
                    <div id="stripePaymentForm" class="form-group" style="display: block;">
                        <label><i class="fas fa-credit-card"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ï‡∏£</label>
                        <div id="card-element" class="stripe-element">
                            <!-- Stripe Elements ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                        </div>
                        <div id="card-errors" role="alert" class="error-message"></div>
                    </div>
                    
                    <!-- File Upload for Transfer Proof -->
                    <div id="transferProofForm" class="form-group" style="display: none;">
                        <label><i class="fas fa-camera"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô *</label>
                        
                        <!-- Enhanced File Upload Area -->
                        <div class="enhanced-file-upload">
                            <input type="file" id="paymentProofFile" accept="image/*,.pdf" style="display: none;" required>
                            <div class="upload-container">
                                <button type="button" class="btn btn-primary upload-btn" onclick="document.getElementById('paymentProofFile').click()">
                                    <i class="fas fa-camera"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ
                                </button>
                                <div class="upload-info">
                                    <span id="fileName" class="file-name-display">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
                                    <small class="upload-hint">
                                        üì± ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ QR Payment
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- File Preview -->
                        <div id="filePreview" class="file-preview-enhanced" style="display: none;">
                            <div class="preview-header">
                                <div class="file-details">
                                    <i class="fas fa-file-image text-success"></i>
                                    <span id="fileInfo" class="file-info-text"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFilePreview()" title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <div class="preview-content">
                                <img id="previewImage" class="preview-image" style="display: none;">
                            </div>
                        </div>
                        
                        <div class="upload-tips">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: JPG, PNG, PDF ‚Ä¢ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: 5MB
                            </small>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-success" onclick="processPayment()">
                            <i class="fas fa-check"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">
                            <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cinema Timeslot Integration Script -->
    <script>
        /**
         * Initialize Cinema Booking System for selected room
         */
        function initializeCinemaBooking(room) {
            try {
                // Destroy existing manager if exists
                if (cinemaManager) {
                    cinemaManager.destroy();
                }

                // Create custom cinema manager for bookings
                const container = document.getElementById('cinema-timeslot-booking');
                container.innerHTML = `
                    <div class="cinema-booking-container" style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); margin: 1rem 0;">
                        <!-- Header -->
                        <div class="cinema-header">
                            <h3 class="cinema-title">
                                <i class="fas fa-clock"></i>
                                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ${room.name}
                            </h3>
                            <p class="cinema-subtitle">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
                        </div>
                        
                        <!-- Date Selection -->
                        <div class="cinema-controls">
                            <div class="control-group">
                                <label class="control-label">
                                    <i class="fas fa-calendar-alt"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                                </label>
                                <input type="date" id="booking-cinema-date" class="cinema-date-input">
                            </div>
                        </div>
                        
                        <!-- Room Info -->
                        <div class="room-info-cinema">
                            <div class="room-info-header">
                                <h4 class="room-name-cinema">
                                    <i class="fas fa-door-open"></i>
                                    ${room.name}
                                </h4>
                                <div class="room-price-cinema">
                                    ${room.price_per_hour}‡∏ø/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                                </div>
                            </div>
                            <div class="room-details-cinema">
                                <div class="room-detail-item">
                                    <i class="fas fa-users"></i>
                                    <span>‡∏à‡∏∏‡πÑ‡∏î‡πâ ${room.capacity} ‡∏Ñ‡∏ô</span>
                                </div>
                                <div class="room-detail-item">
                                    <i class="fas fa-tag"></i>
                                    <span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ${room.type_name}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Screen Indicator -->
                        <div class="cinema-screen">
                            <div class="screen-label">
                                <i class="fas fa-tv"></i> ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
                            </div>
                        </div>
                        
                        <!-- Timeslots Grid -->
                        <div id="booking-timeslots-container" class="timeslots-grid">
                            <div class="cinema-loading">
                                <div class="cinema-spinner"></div>
                                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</p>
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="cinema-legend">
                            <div class="legend-item">
                                <div class="legend-color available"></div>
                                <span>‡∏ß‡πà‡∏≤‡∏á</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color booked"></div>
                                <span>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color selected"></div>
                                <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
                            </div>
                        </div>
                    </div>
                `;

                // Set default date
                const dateInput = document.getElementById('booking-cinema-date');
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                dateInput.value = formattedDate;
                dateInput.min = formattedDate;

                // Bind events
                dateInput.addEventListener('change', (e) => {
                    loadTimeslotsForRoom(room.room_id, e.target.value);
                });

                // Bind timeslot selection
                document.getElementById('booking-timeslots-container').addEventListener('click', (e) => {
                    const button = e.target.closest('.timeslot-btn');
                    if (button && !button.disabled && button.classList.contains('available')) {
                        selectTimeslot(JSON.parse(button.dataset.slot));
                    }
                });

                // Load initial timeslots
                loadTimeslotsForRoom(room.room_id, formattedDate);

            } catch (error) {
                console.error('Failed to initialize cinema booking:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ');
            }
        }

        /**
         * Load timeslots for specific room and date
         */
        async function loadTimeslotsForRoom(roomId, date) {
            const container = document.getElementById('booking-timeslots-container');
            container.innerHTML = `
                <div class="cinema-loading">
                    <div class="cinema-spinner"></div>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á...</p>
                </div>
            `;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/timeslots/${roomId}/${date}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Failed to load timeslots');

                const data = await response.json();
                const timeslots = data.data.slots || [];

                if (timeslots.length === 0) {
                    container.innerHTML = `
                        <div class="cinema-empty">
                            <i class="fas fa-calendar-times"></i>
                            <h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á</h3>
                            <p>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>
                        </div>
                    `;
                    return;
                }

                // Render timeslots
                const slotsHTML = timeslots.map((slot, index) => {
                    const statusClass = slot.available ? 'available' : 'booked';
                    const title = slot.available ? 
                        '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ' : 
                        `‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢ ${slot.booking_info?.user_name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'}`;
                    
                    return `
                        <button 
                            class="timeslot-btn ${statusClass}"
                            data-slot='${JSON.stringify(slot)}'
                            ${!slot.available ? 'disabled' : ''}
                            title="${title}"
                            style="animation-delay: ${index * 0.05}s"
                        >
                            <span class="slot-time">${slot.formatted_time}</span>
                            ${slot.booking_info ? `<small class="slot-booker">${slot.booking_info.user_name}</small>` : ''}
                        </button>
                    `;
                }).join('');

                container.innerHTML = slotsHTML;

            } catch (error) {
                console.error('Failed to load timeslots:', error);
                container.innerHTML = `
                    <div class="cinema-empty">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ</p>
                    </div>
                `;
            }
        }

        /**
         * Select a timeslot
         */
        function selectTimeslot(slot) {
            selectedTimeSlot = slot;
            
            // Update hidden form fields
            document.getElementById('selected_start_time').value = slot.start_time;
            document.getElementById('selected_end_time').value = slot.end_time;
            document.getElementById('selected_duration').value = 1; // Default 1 hour

            // Show selected timeslot info
            const selectedInfo = document.getElementById('selectedTimeSlot');
            selectedInfo.innerHTML = `
                <div class="selected-timeslot-display">
                    <h4>
                        <i class="fas fa-check-circle" style="color: var(--slot-selected);"></i>
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß
                    </h4>
                    <div class="timeslot-details">
                        <div class="detail-item">
                            <i class="fas fa-door-open"></i>
                            <span>${selectedRoom.name}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span>${new Date(slot.start_time).toLocaleDateString('th-TH')}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-clock"></i>
                            <span>${slot.formatted_time} (1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>${selectedRoom.price_per_hour}‡∏ø</span>
                        </div>
                    </div>
                </div>
            `;
            selectedInfo.style.display = 'block';

            // Update button states
            document.querySelectorAll('.timeslot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Find and select the clicked button
            const selectedBtn = Array.from(document.querySelectorAll('.timeslot-btn')).find(btn => {
                const btnSlot = JSON.parse(btn.dataset.slot);
                return btnSlot.slot_id === slot.slot_id;
            });
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }

            // Show booking form
            document.getElementById('bookingForm').style.display = 'block';
            document.getElementById('bookingForm').scrollIntoView({ behavior: 'smooth' });

            updateBookingSummary();
        }

        /**
         * Go back to timeslot selection
         */
        function backToTimeslots() {
            document.getElementById('bookingForm').style.display = 'none';
            document.getElementById('timeslotSelection').scrollIntoView({ behavior: 'smooth' });
            
            // Clear selection
            selectedTimeSlot = null;
            document.getElementById('selected_start_time').value = '';
            document.getElementById('selected_end_time').value = '';
            document.getElementById('selectedTimeSlot').style.display = 'none';
            
            // Clear visual selection
            document.querySelectorAll('.timeslot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        // Update existing booking summary function to use selected timeslot data
        function updateBookingSummary() {
            if (!selectedRoom || !selectedTimeSlot) return;

            const summaryContainer = document.getElementById('bookingSummary');
            if (summaryContainer) {
                summaryContainer.innerHTML = `
                    <div class="booking-summary-item">
                        <span>‡∏´‡πâ‡∏≠‡∏á:</span>
                        <span>${selectedRoom.name}</span>
                    </div>
                    <div class="booking-summary-item">
                        <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
                        <span>${new Date(selectedTimeSlot.start_time).toLocaleDateString('th-TH')}</span>
                    </div>
                    <div class="booking-summary-item">
                        <span>‡πÄ‡∏ß‡∏•‡∏≤:</span>
                        <span>${selectedTimeSlot.formatted_time}</span>
                    </div>
                    <div class="booking-summary-item total">
                        <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</span>
                        <span>${selectedRoom.price_per_hour}‡∏ø</span>
                    </div>
                `;
            }
        }
    </script>

    <!-- Mobile Enhancements Script -->
    <script src="/stylesheets/mobile-enhancements.js"></script>
    
    <!-- Shared authentication functions -->
    <script src="/javascripts/shared/auth.js"></script>
</body>
</html>