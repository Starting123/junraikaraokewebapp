# สรุปการทำงานของระบบ PDF Payment Slip

## ตำแหน่งที่เก็บไฟล์ PDF
ไฟล์ PDF ใบเสร็จจะถูกเก็บไว้ที่:
- **โฟลเดอร์**: `public/receipts/`
- **รูปแบบชื่อไฟล์**: `payment-slip-{booking_id}-{timestamp}.pdf`
- **ตอนอย่างเช่น**: `payment-slip-6-2025-10-09T14-30-25-123Z.pdf`

## วิธีการทำงาน
1. **เมื่อผู้ใช้คลิกปุ่ม "ใบเสร็จ PDF"**:
   - JavaScript เรียก API: `GET /api/bookings/{booking_id}/payment-slip`
   
2. **API ตรวจสอบข้อมูล**:
   - ตรวจสอบว่ามี booking นี้ในฐานข้อมูลหรือไม่
   - ตรวจสอบว่าผู้ใช้มีสิทธิ์เข้าถึงการจองนี้หรือไม่  
   - ตรวจสอบว่าชำระเงินแล้วหรือไม่ (payment_status = 'paid')

3. **สร้าง PDF**:
   - สร้างไฟล์ PDF ด้วย PDFKit
   - บันทึกไฟล์ในโฟลเดอร์ `public/receipts/`
   - ส่งไฟล์ให้ผู้ใช้ดาวน์โหลด (stream response)

4. **อัปเดตฐานข้อมูล**:
   - บันทึก path ของไฟล์ PDF ในฟิลด์ `receipt_pdf_path` ของตาราง `bookings`

## ข้อมูลในใบเสร็จ PDF
- เลขที่ใบเสร็จ (Booking ID)
- วันที่ออกใบเสร็จ
- ข้อมูลลูกค้า (ชื่อ, อีเมล, เบอร์โทร)
- รายละเอียดการจอง (ห้อง, วันที่, เวลา, ระยะเวลา)
- รายละเอียดการชำระเงิน (ราคา, ยอดรวม, วิธีการชำระ)
- ข้อมูลร้าน Junrai Karaoke

## การเข้าถึงไฟล์
- **ผ่าน Web**: `http://localhost:3000/receipts/{filename}.pdf`
- **ในระบบไฟล์**: `app/public/receipts/{filename}.pdf`
- **บันทึกในฐานข้อมูล**: ฟิลด์ `receipt_pdf_path` ในตาราง `bookings`

## การรักษาความปลอดภัย
- เฉพาะเจ้าของการจองและ Admin เท่านั้นที่ดาวน์โหลดได้
- ตรวจสอบ JWT token ก่อนทุกครั้ง
- ตรวจสอบสถานะการชำระเงินก่อนสร้าง PDF

## ข้อกำหนดการใช้งาน
- ต้องรัน SQL script `add_receipt_column.sql` เพื่อเพิ่มคอลัมน์ในฐานข้อมูล
- ต้องติดตั้ง PDFKit: `npm install pdfkit`
- ใช้ได้เฉพาะการจองที่มี `payment_status = 'paid'`