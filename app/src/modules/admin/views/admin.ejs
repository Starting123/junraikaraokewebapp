<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดผู้ดูแล - Junrai Karaoke</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/admin.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <%- include('../../../../views/partials/navbar') %>

    <!-- Header Section -->
    <section class="admin-header">
        <div class="container">
            <div class="header-content">
                <h1>
                    <i class="fas fa-cogs"></i>
                    แดชบอร์ดผู้ดูแลระบบ
                </h1>
                <p id="welcomeMessage">ยินดีต้อนรับผู้ดูแลระบบ</p>
            </div>
        </div>
    </section>

    <!-- Admin Content -->
    <section class="admin-content">
        <div class="container">
            <!-- System Statistics -->
            <div class="section-header">
                <h2>สรุประบบ</h2>
                <p>ภาพรวมการใช้งานระบบ</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card total-users">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalUsers">-</h3>
                        <p>ผู้ใช้ทั้งหมด</p>
                        <small class="stat-change" id="usersChange">+0 ใหม่วันนี้</small>
                    </div>
                </div>
                
                <div class="stat-card total-rooms">
                    <div class="stat-icon">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalRooms">-</h3>
                        <p>ห้องทั้งหมด</p>
                        <small class="stat-change" id="roomsAvailable">0 ห้องว่าง</small>
                    </div>
                </div>
                
                <div class="stat-card total-bookings">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalBookings">-</h3>
                        <p>การจองวันนี้</p>
                        <small class="stat-change" id="bookingsChange">+0 ใหม่วันนี้</small>
                    </div>
                </div>
                
                <div class="stat-card total-revenue">
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalRevenue">-</h3>
                        <p>รายได้วันนี้</p>
                        <small class="stat-change" id="revenueChange">฿0 เพิ่มขึ้น</small>
                    </div>
                </div>
            </div>

            <!-- Admin Actions -->
            <div class="section-header">
                <h2>เมนูจัดการ</h2>
                <p>เลือกการดำเนินการที่ต้องการ</p>
            </div>
            
            <div class="admin-actions">
                <div class="action-card" onclick="showManageRooms()">
                    <div class="action-icon">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <h3>จัดการห้อง</h3>
                    <p>เพิ่ม แก้ไข หรือลบห้องคาราโอเกะ</p>
                </div>
                
                <div class="action-card" onclick="showManageBookings()">
                    <div class="action-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h3>จัดการการจอง</h3>
                    <p>ดูและจัดการการจองทั้งหมด</p>
                </div>
                
                <div class="action-card" onclick="showManageUsers()">
                    <div class="action-icon">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <h3>จัดการผู้ใช้</h3>
                    <p>ดูและจัดการข้อมูลผู้ใช้</p>
                </div>
                
                <div class="action-card" onclick="showReports()">
                    <div class="action-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3>รายงาน</h3>
                    <p>ดูรายงานการใช้งานและรายได้</p>
                </div>
            </div>

            <!-- Management Sections (Initially Hidden) -->
            
            <!-- Manage Rooms Section -->
            <div class="management-section" id="manageRooms" style="display: none;">
                <div class="section-header">
                    <h2>จัดการห้อง</h2>
                    <button class="btn btn-primary" onclick="openRoomModal('add')">
                        <i class="fas fa-plus"></i>
                        เพิ่มห้องใหม่
                    </button>
                </div>
                <div class="table-container">
                    <table class="admin-table" id="roomsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ชื่อห้อง</th>
                                <th>ความจุ</th>
                                <th>ราคา/ชม.</th>
                                <th>สถานะ</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="roomsTableBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>กำลังโหลดข้อมูล...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                    <style>
                    .action-btn {
                        display: inline-block;
                        padding: 0.45em 1.1em;
                        margin: 0 0.15em;
                        border-radius: 8px;
                        border: none;
                        font-size: 1em;
                        font-weight: 500;
                        background: #fff;
                        color: #a55a00;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
                        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
                        cursor: pointer;
                        outline: none;
                    }
                    .action-btn-edit {
                        background: #ffe5b2;
                        color: #a55a00;
                    }
                    .action-btn-edit:hover {
                        background: #ffd580;
                        color: #a55a00;
                        box-shadow: 0 4px 16px rgba(165,90,0,0.12);
                    }
                    .action-btn-delete {
                        background: #ffd6d6;
                        color: #c0392b;
                    }
                    .action-btn-delete:hover {
                        background: #ffb3b3;
                        color: #c0392b;
                        box-shadow: 0 4px 16px rgba(192,57,43,0.12);
                    }
                    .action-btn-detail {
                        background: #e6f7ff;
                        color: #0077b6;
                    }
                    .action-btn-detail:hover {
                        background: #b3e6ff;
                        color: #0077b6;
                        box-shadow: 0 4px 16px rgba(0,119,182,0.12);
                    }
                    </style>
                <!-- Room Modal -->
                <style>
                .modal {
                    position: fixed;
                    top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.25);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                }
                .modal-content {
                    background: #fff;
                    border-radius: 16px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
                    padding: 2.5em 2em 2em 2em;
                    min-width: 340px;
                    max-width: 400px;
                    position: relative;
                    margin: auto;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                }
                .modal-content {
                    background: #fff;
                    border-radius: 16px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
                    padding: 2.5em 2em 2em 2em;
                    min-width: 340px;
                    max-width: 400px;
                    position: relative;
                }
                .modal-content h3 {
                    margin-top: 0;
                    color: #a55a00;
                    font-size: 1.5em;
                    font-weight: bold;
                }
                .modal-content .close {
                    position: absolute;
                    top: 18px;
                    right: 18px;
                    font-size: 1.5em;
                    color: #a55a00;
                    cursor: pointer;
                }
                #roomSummary {
                    margin-bottom: 1.5em;
                    background: #f8f8f8;
                    border-radius: 10px;
                    padding: 1em 1.2em;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
                    display: none;
                }
                #roomSummary h4 {
                    margin: 0 0 0.5em 0;
                    color: #a55a00;
                    font-size: 1.1em;
                }
                #roomSummary ul {
                    list-style: none;
                    padding: 0;
                    margin: 0;
                }
                #roomSummary li {
                    margin-bottom: 0.3em;
                    font-size: 1em;
                }
                #roomForm .form-group {
                    margin-bottom: 1.1em;
                }
                #roomForm label {
                    display: block;
                    font-weight: 500;
                    margin-bottom: 0.3em;
                    color: #a55a00;
                }
                #roomForm input, #roomForm select {
                    width: 100%;
                    padding: 0.5em 0.7em;
                    border-radius: 6px;
                    border: 1px solid #d6cfc2;
                    font-size: 1em;
                    background: #f9f7f3;
                    box-sizing: border-box;
                }
                #roomForm button[type="submit"] {
                    width: 100%;
                    background: #6bbf59;
                    color: #fff;
                    border: none;
                    border-radius: 8px;
                    padding: 0.7em;
                    font-size: 1.1em;
                    font-weight: bold;
                    margin-top: 0.7em;
                    cursor: pointer;
                    transition: background 0.2s;
                }
                #roomForm button[type="submit"]:hover {
                    background: #4e9c3e;
                }
                </style>
                <div id="roomModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close" onclick="closeRoomModal()">&times;</span>
                        <h3 id="roomModalTitle">เพิ่ม/แก้ไขห้อง</h3>
                        <div id="roomSummary">
                            <h4>ข้อมูลห้องปัจจุบัน</h4>
                            <ul>
                                <li><strong>ID:</strong> <span id="summaryRoomId">-</span></li>
                                <li><strong>ชื่อห้อง:</strong> <span id="summaryRoomName">-</span></li>
                                <li><strong>ความจุ:</strong> <span id="summaryRoomCapacity">-</span></li>
                                <li><strong>ราคา/ชม.:</strong> <span id="summaryRoomPrice">-</span></li>
                                <li><strong>สถานะ:</strong> <span id="summaryRoomStatus">-</span></li>
                            </ul>
                        </div>
                        <form id="roomForm">
                            <input type="hidden" id="roomId">
                            <div class="form-group">
                                <label>ชื่อห้อง</label>
                                <input type="text" id="roomName" required>
                            </div>
                            <div class="form-group">
                                <label>ความจุ</label>
                                <input type="number" id="roomCapacity" required>
                            </div>
                            <div class="form-group">
                                <label>ประเภทห้อง</label>
                                <select id="roomType" required onchange="updateRoomPriceByType()">
                                    <option value="1" data-price="99">Small (฿99/ชม.)</option>
                                    <option value="2" data-price="199">Medium (฿199/ชม.)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ราคา/ชม.</label>
                                <input type="number" id="roomPrice" required readonly style="background:#eee;">
                            </div>
                            <div class="form-group">
                                <label>สถานะ</label>
                                <select id="roomStatus">
                                    <option value="available">ว่าง</option>
                                    <option value="unavailable">ไม่ว่าง</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">บันทึก</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Manage Bookings Section -->
            <div class="management-section" id="manageBookings" style="display: none;">
                <div class="section-header">
                    <h2>จัดการการจอง</h2>
                    <div class="filter-controls">
                        <select id="bookingStatusFilter">
                            <option value="">ทุกสถานะ</option>
                            <option value="pending">รอยืนยัน</option>
                            <option value="confirmed">ยืนยันแล้ว</option>
                            <option value="cancelled">ยกเลิกแล้ว</option>
                            <option value="completed">เสร็จสิ้น</option>
                        </select>
                        <input type="date" id="bookingDateFilter">
                        <button class="btn btn-outline" onclick="filterBookings()">
                            <i class="fas fa-filter"></i>
                            กรอง
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="admin-table" id="bookingsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ลูกค้า</th>
                                <th>ห้อง</th>
                                <th>วันที่</th>
                                <th>เวลา</th>
                                <th>สถานะ</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>กำลังโหลดข้อมูล...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Booking Details/Edit Modal -->
                <style>
                #bookingModal.modal {
                    display: flex !important;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                }
                .modal-booking-content {
                    background: #fff;
                    border-radius: 16px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
                    padding: 2.5em 2em 2em 2em;
                    min-width: 340px;
                    max-width: 480px;
                    position: relative;
                    margin: auto;
                }
                .modal-booking-content h3 {
                    margin-top: 0;
                    color: #a55a00;
                    font-size: 1.5em;
                    font-weight: bold;
                }
                .modal-booking-content .close {
                    position: absolute;
                    top: 18px;
                    right: 18px;
                    font-size: 1.5em;
                    color: #a55a00;
                    cursor: pointer;
                }
                .booking-details-list {
                    list-style: none;
                    padding: 0;
                    margin: 0 0 1.2em 0;
                }
                .booking-details-list li {
                    margin-bottom: 0.5em;
                    font-size: 1em;
                }
                .booking-actions {
                    display: flex;
                    gap: 0.7em;
                    margin-top: 1.2em;
                }
                .btn-view-pdf {
                    background: #f7b731;
                    color: #fff;
                    border: none;
                    border-radius: 8px;
                    padding: 0.6em 1.2em;
                    font-size: 1em;
                    font-weight: bold;
                    cursor: pointer;
                }
                .btn-edit-booking {
                    background: #6bbf59;
                    color: #fff;
                    border: none;
                    border-radius: 8px;
                    padding: 0.6em 1.2em;
                    font-size: 1em;
                    font-weight: bold;
                    cursor: pointer;
                }
                </style>
                <div id="bookingModal" class="modal" style="display:none;visibility:hidden;">
                    <div class="modal-booking-content">
                        <span class="close" onclick="closeBookingModal()">&times;</span>
                        <h3 id="bookingModalTitle">รายละเอียดการจอง</h3>
                        <ul class="booking-details-list" id="bookingDetailsList">
                            <li><strong>ID:</strong> <span id="modalBookingId">-</span></li>
                            <li><strong>ลูกค้า:</strong> <span id="modalBookingUser">-</span></li>
                            <li><strong>ห้อง:</strong> <span id="modalBookingRoom">-</span></li>
                            <li><strong>วันที่:</strong> <span id="modalBookingDate">-</span></li>
                            <li><strong>เวลา:</strong> <span id="modalBookingTime">-</span></li>
                            <li><strong>สถานะ:</strong> <span id="modalBookingStatus">-</span></li>
                            <li><strong>ราคา:</strong> <span id="modalBookingPrice">-</span></li>
                            <li><strong>PDF ใบเสร็จ:</strong> <span id="modalBookingPDF">-</span></li>
                        </ul>
                        <form id="bookingEditForm" style="display:none;">
                            <div class="form-group">
                                <label>สถานะ</label>
                                <select id="editBookingStatus">
                                    <option value="pending">รอยืนยัน</option>
                                    <option value="active">active</option>
                                    <option value="completed">completed</option>
                                    <option value="cancelled">cancelled</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>วันที่</label>
                                <input type="date" id="editBookingDate">
                            </div>
                            <div class="form-group">
                                <label>เวลาเริ่ม</label>
                                <input type="time" id="editBookingStart">
                            </div>
                            <div class="form-group">
                                <label>เวลาสิ้นสุด</label>
                                <input type="time" id="editBookingEnd">
                            </div>
                            <button type="submit" class="btn-edit-booking" style="width:100%;margin-top:1em;">บันทึกการแก้ไข</button>
                        </form>
                        <div class="booking-actions" id="bookingActions">
                            <button class="btn-view-pdf" id="btnViewPDF" onclick="viewBookingPDF()">ดูใบเสร็จ PDF</button>
                            <button class="btn-edit-booking" id="btnEditBooking" onclick="editBookingModal()">แก้ไขข้อมูล</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Users Section -->
            <div class="management-section" id="manageUsers" style="display: none;">
                <div class="section-header">
                    <h2>จัดการผู้ใช้</h2>
                    <div class="filter-controls">
                        <select id="userRoleFilter">
                            <option value="">ทุกประเภท</option>
                            <option value="1">ผู้ดูแลระบบ</option>
                            <option value="2">พนักงาน</option>
                            <option value="3">ลูกค้า</option>
                        </select>
                        <input type="text" id="userSearchInput" placeholder="ค้นหาชื่อหรืออีเมล">
                        <button class="btn btn-outline" onclick="filterUsers()">
                            <i class="fas fa-search"></i>
                            ค้นหา
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="admin-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ชื่อ</th>
                                <th>อีเมล</th>
                                <th>ประเภท</th>
                                <th>วันที่สมัคร</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                        <p>กำลังโหลดข้อมูล...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- User Details Modal (popup, hidden by default, created by JS) -->
                <style>
                #userDetailsModal.modal {
                    display: none;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                    z-index: 9999;
                }
                #userDetailsModal .modal-content {
                    background: #fff;
                    border-radius: 16px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
                    padding: 2em 2em 2em 2em;
                    min-width: 340px;
                    max-width: 420px;
                    position: relative;
                }
                #userDetailsModal .close {
                    position: absolute;
                    top: 18px;
                    right: 18px;
                    font-size: 1.5em;
                    color: #a55a00;
                    cursor: pointer;
                }
                #userDetailsModal h3 {
                    margin-top: 0;
                    color: #a55a00;
                    font-size: 1.5em;
                    font-weight: bold;
                }
                #userDetailsModal ul {
                    list-style: none;
                    padding: 0;
                    margin: 0 0 1em 0;
                }
                #userDetailsModal li {
                    margin-bottom: 0.7em;
                    font-size: 1em;
                }
                #userDetailRole {
                    width: 100%;
                    padding: 0.5em 0.7em;
                    border-radius: 6px;
                    border: 1px solid #d6cfc2;
                    font-size: 1em;
                    background: #f9f7f3;
                    box-sizing: border-box;
                }
                #saveUserRoleBtn {
                    width: 100%;
                    background: #6bbf59;
                    color: #fff;
                    border: none;
                    border-radius: 8px;
                    padding: 0.7em;
                    font-size: 1.1em;
                    font-weight: bold;
                    margin-top: 0.7em;
                    cursor: pointer;
                    transition: background 0.2s;
                }
                #saveUserRoleBtn:hover {
                    background: #4e9c3e;
                }
                </style>
            </div>

            <!-- Reports Section -->
            <div class="management-section" id="reports" style="display: none;">
                <div class="section-header">
                    <h2>รายงาน</h2>
                    <p>ดูรายงานการใช้งานและรายได้</p>
                </div>
                
                <div class="reports-grid">
                    <div class="report-card">
                        <h3>รายได้รายเดือน</h3>
                        <canvas id="monthlyRevenueChart" width="400" height="220"></canvas>
                    </div>
                    <div class="report-card">
                        <h3>ห้องยอดนิยมรายวัน</h3>
                        <canvas id="popularRoomsChart" width="400" height="220"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- JavaScript -->
    <script src="/js/admin.js"></script>
    <script src="/js/admin-crud.js"></script>
    <script>
    // Render charts from real bookings data
    document.addEventListener('DOMContentLoaded', async function() {
        // Fetch bookings data from API
        const token = localStorage.getItem('token');
        let bookings = [];
        try {
            const res = await fetch('/api/admin/bookings', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await res.json();
            bookings = (result.data && result.data.bookings) ? result.data.bookings : [];
        } catch (err) {
            bookings = [];
        }

        // Monthly Revenue Calculation
        const monthLabels = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
        const monthlyRevenue = Array(12).fill(0);
        bookings.forEach(b => {
            if (b.start_time && b.total_price) {
                const date = new Date(b.start_time);
                const month = date.getMonth();
                monthlyRevenue[month] += Number(b.total_price);
            }
        });
        // Render Monthly Revenue Chart
        const ctxRevenue = document.getElementById('monthlyRevenueChart').getContext('2d');
        window.monthlyRevenueChart = new Chart(ctxRevenue, {
            type: 'bar',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: 'รายได้ (บาท)',
                    data: monthlyRevenue,
                    backgroundColor: '#6bbf59',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Popular Rooms Calculation (today)
        const todayStr = new Date().toISOString().slice(0, 10);
        const roomCounts = {};
        bookings.forEach(b => {
            if (b.start_time && b.room_name) {
                const dateStr = b.start_time.slice(0, 10);
                if (dateStr === todayStr) {
                    roomCounts[b.room_name] = (roomCounts[b.room_name] || 0) + 1;
                }
            }
        });
        const roomLabels = Object.keys(roomCounts);
        const roomData = Object.values(roomCounts);
        // Render Popular Rooms Chart
        const ctxRooms = document.getElementById('popularRoomsChart').getContext('2d');
        window.popularRoomsChart = new Chart(ctxRooms, {
            type: 'doughnut',
            data: {
                labels: roomLabels.length ? roomLabels : ['ไม่มีข้อมูล'],
                datasets: [{
                    label: 'จำนวนการจอง',
                    data: roomData.length ? roomData : [0],
                    backgroundColor: [
                        '#6bbf59', '#f7b731', '#e6f7ff', '#ffd6d6', '#ffe5b2', '#a55a00', '#0077b6', '#c0392b'
                    ].slice(0, roomLabels.length || 1),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: false }
                }
            }
        });
    });
    </script>
</body>
</html>